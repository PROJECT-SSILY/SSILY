<template>
<div class="wrap_component">
    <!----------------------------------- 개발용 버튼 -------------------------------------->
        <p>
            <v-btn @click="clickTest">게임 시작 테스트</v-btn> |
            <v-btn @click="state.isTeamBattle = !state.isTeamBattle">팀/개인전 변경</v-btn> |
            <v-btn>게임 순서 변경</v-btn>
        </p>
    <!------------------------------------------------------------------------------------->
    <div class="waiting_component" v-if="!readyAll">
        <div class="users_component">
            <WaitingPage
            :sessionId="state.sessionId"
            :playerList="state.playerList"
            :session="state.session"
            :myConnectionId="state.connectionId"
            :team="state.team"
            />
        </div>
        <div class="side_component flex-item">
            <v-radio-group class="select_team" inline v-model="state.team" justify-content="center">
                <v-radio label="RED" value="RED" color="red" class="ma-2" @click="clickTeam(RED)"></v-radio>
                <v-radio label="BLUE" value="BLUE" color="indigo" class="ma-2" @click="clickTeam(BLUE)"></v-radio>
            </v-radio-group>
            <div class="chat_box">
                <ChattingBox/>
            </div>
            <div class="side_footer">
                <div class="sidebtn">
                    <v-btn class="readybtn" v-if="!state.ready" @Click="clickReady">READY</v-btn>
                    <v-btn class="readybtn" v-if="state.ready" @Click="clickReady">CANCEL READY</v-btn>
                </div>
                <div class="sidebtn">
                    <v-btn class="exitbtn" @click="clickExit">EXIT</v-btn>
                </div>
            </div>
            <div class="sidebtn">
                    <v-btn class="exitbtn" @click="gameStart()">Game Start</v-btn>
            </div>
        </div>
    </div>
    <div class="in_game_component" v-else>
        <GameTimer date="August 15, 2016"/>
        <v-container>
            <v-row>
                <v-col>
                    <h1>상대 팀</h1>
                    <user-video v-for="sub in opponents" :key="sub.stream.connection.connectionId" :stream-manager="sub"/>
                </v-col>
                <v-col>
                    <div id="video-container" class="col-md-6">
                        <div class="me">
                            <h1>나</h1>
                            <div class="drawing_sec" v-if="!amIDescriber">
                                <MyCanvasBox/>
                                <user-video :stream-manager="publisher"/>
                            </div>
                            <div class="displaying_sec" v-else>
                                <user-video :stream-manager="publisher"/>
                            </div>
                        </div>
                        <div class="our_team">
                            <h1>우리 팀</h1>
                            <div class="drawing_sec" v-if="amIDescriber">
                                <user-video v-for="opp in opponents" :key="opp.stream.connection.connectionId"  :stream-manager="opp"/>
                                <MyCanvasBox/>
                            </div>
                            <div class="displaying_sec" v-else>
                                <user-video v-for="opp in opponents" :key="opp.stream.connection.connectionId"  :stream-manager="opp"/>
                            </div>
                        </div>
                    </div>
                </v-col>
            </v-row>
        </v-container>
    </div>
</div>
</template>
<script>
import GameTimer from './components/GameTimer.vue';
import UserVideo from './components/UserVideo.vue';
import MyCanvasBox from './components/MyCanvasBox.vue'
import WaitingPage from '@/views/WaitingPage/WaitingPage.vue';
import ChattingBox from '@/views/WaitingPage/components/ChattingBox.vue';
import $axios from "axios";
import { useStore } from 'vuex';
import { useRoute, useRouter } from 'vue-router'

// import { OpenVidu } from "openvidu-browser";
import { reactive } from '@vue/reactivity'
// import { GetPlayerList } from "@/common/api/gameAPI";
import { onBeforeMount, computed } from 'vue';
// import { forEach } from 'vega-lite/build/src/encoding';

//=================OpenVdue====================

$axios.defaults.headers.post['Content-Type'] = 'application/json';
// const OPENVIDU_SERVER_URL = "https://localhost:4443";
// const OPENVIDU_SERVER_SECRET = "MY_SECRET";

//=============================================

export default {
    name : "InGamePage",
    components: {
        GameTimer,
		UserVideo,
        MyCanvasBox,
        WaitingPage,
        ChattingBox,
    },
    props:{
        ready: Boolean
    },
    setup() {
        const store = useStore()
        const route = useRoute() // URL 파라미터를 통한 sessionId 얻기
        // const route = useRoute() // URL 파라미터를 통한 sessionId 얻기
        const userList = computed(() => store.state.gameStore.userList)
        const getUserList = store.getters['gameStore/getUserList']
        const readyAll = computed(() => store.state.gameStore.isAllReady)
        const amIDescriber = computed(() => store.state.gameStore.amIDescriber)
        const router = useRouter()
        const state = reactive({
            title: null,
            isSecret: false,
            password: null,
            isTeamBattle: null,
            // OV: undefined,
            // session: undefined,
            mainStreamManager: undefined,
            // publisher: null,
            // subscribers: [],
            sessionId: route.params.sessionId || null,
            // myUserName: '',
            isHost: true,
            connectionId: null,
            

            // 팀 분류
            myTeam: null,
            opponentTeam: [],

            // 게임 순서 관련
            ready: false,
            team: null,
        })


        // == OpenVidu State ==
        // const OV = computed(() => store.state.gameStore.OV)
        // const session = computed(() => store.state.gameStore.session)
        // const title = computed(() => store.state.gameStore.title)
        // const mainStreamManager = computed(() => store.state.gameStore.mainStreamManager )
        const publisher = computed(() => store.state.gameStore.publisher )
        const myTeams = computed(() => store.getters['gameStore/getMyTeams'])
        const opponents = computed(() => store.getters['gameStore/getOpponents'])
        // const subscribers = computed(() => store.state.gameStore.subscribers )
        // const myTeams = computed(() => {
        //     const tmp = reactive([])
        //     console.log("여기까지도 하맣맣맣", subscribers.value)
        //     subscribers.forEach((subscriber) => {
        //         console.log("subscriber : ", subscriber)
        //         if(subscriber.team === publisher.value.team) {
        //             tmp.push(subscriber)
        //         }
        //     })
        //     return tmp
        // })
        // onMounted(() => {
        //     console.log(myTeams.value)
        // })
        // const mySessionId = computed(() => store.state.gameStore.mySessionId )
        // const myUserName = computed(() => store.state.gameStore.myUserName )
        // =====================



        onBeforeMount(async () => {
            await store.dispatch('accountStore/getMeAction')
            console.log('join start');
            joinSession()
        })

        const joinSession = async function() {
            await store.commit('gameStore/setSessionId', state.sessionId) // 실행 전 세션id 저장 | 이은혁
            await store.dispatch('gameStore/joinSession', state.sessionId)
            }

        const leaveSession = async function() {
            store.dispatch('gameStore/leaveSession')
            window.removeEventListener('beforeunload', leaveSession);
        }

        const updateMainVideoStreamManager = async function(stream) {
            store.dispatch('gameStore/updateMainVideoStreamManager',stream)
        }

        const clickExit = () => {
            store.dispatch('gameStore/leaveSession')
            router.push({
                name: 'main'
            })
        }

        const clickReady = () => {
            store.dispatch('gameStore/changeReady')
        }

        const clickTeam = (color) => {
            store.dispatch('gameStore/changeTeamAction', color)
        }
        const clickTest = () => {
            console.log('clickTest 클릭')
            store.dispatch('gameStore/changeTest', true)
            store.dispatch('gameStore/gameStart')
        }

        const gameStart = () => {
            store.dispatch('gameStore/gameStart')
        }
        // onUpdated(() => {
            // if (!state.readyAll) {
                // document.querySelector(".waiting_component").innerHTML
                // playerList.value
                // state.session
                // state.team
                // console.log(state.team)
            // }

            // 팀 분류하여 리스트에 추가
            // let tmpMyTeam = null
            // const tmpOpponentTeam = []
            // for(let i=0; i<state.subscribers.length; i++) {
            //     // console.log("state.publisher : ", state.publisher)
            //     if(state.subscribers[i].team === state.publisher.team) {
            //         tmpMyTeam = state.subscribers[i]
            //     } else {
            //         tmpOpponentTeam.push(state.subscribers[i])
            //     }
            // }
            // console.log("playerList.value.length::::::::::", playerList.value.length)
            // state.myTeam = tmpMyTeam
            // state.opponentTeam = tmpOpponentTeam
        // })

        // const joinSession = async () => {
        //     console.log("joinsession 시작")
        //     // --- Get an OpenVidu object ---
        //     state.OV = new OpenVidu();

        //     // --- Init a session ---
        //     state.session = state.OV.initSession();


        //     // On every asynchronous exception...
        //     state.session.on('exception', ({ exception }) => {
        //         console.warn(exception);
        //     });

        //     // state.session.on("signal:chat", (event)=>{
        //     //     const { message } = JSON.parse(event.data);
        //     //     const { user, chatMessage } = message
        //     //     const data = user + " : " + chatMessage
        //     //     store.commit('gameStore/SET_MESSAGES', data)
        //     // });

        //     // --- Connect to the session with a valid user token ---
        //     // 'getToken' method is simulating what your server-side should do.
        //     // 'token' parameter should be retrieved and returned by your own backend

        //     await getToken(state.sessionId).then(token => {
        //         state.session.connect(token, { clientData: state.myUserName })

        //         requestPlayerList(state.sessionId).then(response => {
        //         const resLength= response.content.length;
        //         // console.log("res 찍자", response.content);
        //         for(let i=0;i<resLength;i++){
        //             state.playerList.push(response.content[i]);
        //         }
        //         store.commit('gameStore/setSession', state.session)
        //         sessionVal.value.push(state.session)
        //         })
        //         .then(() => {
        //             // --- Get your own camera stream with the desired properties ---
        //             let publisher = state.OV.initPublisher(undefined, {
        //                 audioSource: undefined, // The source of audio. If undefined default microphone
        //                 videoSource: undefined, // The source of video. If undefined default webcam
        //                 publishAudio: true,  	// Whether you want to start publishing with your audio unmuted or not
        //                 publishVideo: true,  	// Whether you want to start publishing with your video enabled or not
        //                 resolution: '640x480',  // The resolution of your video
        //                 frameRate: 30,			// The frame rate of your video
        //                 insertMode: 'APPEND',	// How the video is inserted in the target element 'video-container'
        //                 mirror: false       	// Whether to mirror your local video or not
        //             });
        //             state.mainStreamManager = publisher;
        //             state.publisher = publisher;







        // const leaveSession = () => {
        //     // --- Leave the session by calling 'disconnect' method over the Session object ---
        //     if (state.session) state.session.disconnect();

        //     state.session = undefined;
        //     state.mainStreamManager = undefined;
        //     state.publisher = undefined;
        //     state.subscribers = [];
        //     state.OV = undefined;

        //     window.removeEventListener('beforeunload', leaveSession);
        // }

        // const updateMainVideoStreamManager = (stream) => {
        //     if (state.mainStreamManager === stream) return;
        //     state.mainStreamManager = stream;
        //     }

        /**
        * --------------------------
        * SERVER-SIDE RESPONSIBILITY
        * --------------------------
        * These methods retrieve the mandatory user token from OpenVidu Server.
        * state behavior MUST BE IN YOUR SERVER-SIDE IN PRODUCTION (by using
        * the API REST, openvidu-java-client or openvidu-node-client):
        *   1) Initialize a Session in OpenVidu Server	(POST /openvidu/api/sessions)
        *   2) Create a Connection in OpenVidu Server (POST /openvidu/api/sessions/<SESSION_ID>/connection)
        *   3) The Connection.token must be consumed in Session.connect() method
        */

        // const getToken = async (sessionId) => {
        //     const response = await createToken(sessionId)
        //     state.connectionId = response.connectionId
        //     // console.log('connectionId ===>', state.connectionId)
        //     return response.token
        // }

        // See https://docs.openvidu.io/en/stable/reference-docs/REST-API/#post-connection
        // const createToken = (sessionId) => {
        //     const level = store.state.accountStore.user.level || 1
        //     const nickname = store.state.accountStore.user.nickname || ''
        //     const isHost = store.state.gameStore.isHost || true
        //     const rate = store.getters['accountStore/getRate']
        //     const password = store.state.gameStore.password || true
        //     const exp = store.state.accountStore.user.exp || 0
        //     state.myUserName=store.state.accountStore.user.nickname || ''

        //     return new Promise((resolve, reject)=> {
        //         // console.log("level=",level);
        //         // console.log("nickname=",nickname);
        //         // console.log("isHost=", isHost);
        //         // console.log("rate=", rate);
        //         // console.log("exp", exp)
        //         $axios
        //             .post(`${OPENVIDU_SERVER_URL}/api/rooms/${sessionId}`, JSON.stringify({
        //             "level" : level,
        //             "nickname" : nickname,
        //             "rate" : rate,
        //             "isHost" : isHost,
        //             "password" : password,
        //             "exp": exp,
        //         }), {
        //             auth: {
        //                 username: 'OPENVIDUAPP',
        //                 password: OPENVIDU_SERVER_SECRET,
        //             },
        //         })
        //         .then(response => resolve(response.data))
        //         .catch(error => reject(error.response));
        //     })
        // }


        return {
            router,
            state,
            // team,
            // title,
            readyAll,
            publisher,
            myTeams,
            opponents,
            // subscribers,
            clickExit,
            clickTest,
            clickReady,
            clickTeam,
            gameStart,
            joinSession,
            leaveSession,
            updateMainVideoStreamManager,
            userList,
            getUserList,
            amIDescriber
        }
    }
}
</script>

<style scoped>
.wrap_component {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.waiting_component {
    display: flex;
    flex-direction: row;
    padding: 20px;
    max-width: 1200px;
    min-width: 800px;
    width: 100%;
    justify-content: space-between;
}
.side_component {
    width: 300px;
    padding: 20px 0;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.select_team {
    display: flex;
    border-radius: 30px;
    background-color: #ffffffeb;
    justify-content: center;
    margin-bottom: 10px;
}
.chat_box {
    flex: auto;
    border-radius: 30px;
    height: 500px;
    background-color: #ffffffeb;
    display: flex;
    flex-direction: column-reverse;
    justify-content: space-between;
    padding: 20px 30px;
}

.sidebtn {
    display: inline-block;
    width: 50%;
    padding-top: 10px;
}
.sidebtn:first-child {
    padding-right: 5px;
}
.sidebtn:last-child {
    padding-left: 5px;
}
.sidebtn>button {
    width:100%;
    margin: 0px;
    border-radius: 20px;
    height: 70px;
    box-sizing: border-box;
    font-family: sans-serif;
    font-weight: 900;
    font-size: 25px;
    border: 7px solid #ffffffeb;
}
.readybtn {
    background: linear-gradient(342deg, rgba(198,255,0,1) 0%, rgba(108,204,55,1) 100%);
}
.exitbtn {
    background: rgb(224,61,61);
background: linear-gradient(133deg, rgba(224,61,61,1) 0%, rgba(255,93,93,1) 100%);
}
</style>