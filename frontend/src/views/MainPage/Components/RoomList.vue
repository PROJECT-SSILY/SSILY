<template>
  <div class="roomlist">
    <div class="inner-roomlist">
      <v-img src="@/assets/images/earth.png" id="earth" alt="earth" />
      <div class="wrap-btn">
        <button
          @click="state.isTeamBattle = false"
          :class="state.isTeamBattle ? '' : 'active'"
        >
          개인전
        </button>
        <button
          @click="state.isTeamBattle = true"
          :class="state.isTeamBattle ? 'active' : ''"
        >
          팀전
        </button>
      </div>
      <alert-dialog v-if="state.alert"/>
      <div class="wrap-list">
        <RoomListItem
          v-for="room in paginatedData"
          :key="room.id"
          :room="room"
          @click="getInRoom(room)"
          class="list-item"
        />
        <div
        class="list-item blank"
        v-for="blank in 5 - paginatedData.length"
        :key="blank"
        ></div>
        <div class="btn-paging">
          <button 
          @click="prevPage" 
          v-if="!prevButtonDisabled"
          >PREV</button>
          <button 
          @click="nextPage"
          v-if="!nextButtonDisabled" 
          >NEXT</button>
        </div>
        <div v-if="state.passwordDialog">
          <password-input
          v-for="room in state.roomlist"
          :key="room.id"
          :room="room"/>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
import { useStore } from "vuex";
import { useRouter } from "vue-router";
import { reactive, onMounted, computed } from "vue";
import { roomList, room } from "@/common/api/gameAPI";
import RoomListItem from "@/views/MainPage/Components/RoomListItem.vue";
import PasswordInput from "@/views/WaitingPage/components/PasswordInput.vue";
import AlertDialog from '../../AlertDialog.vue'

export default {
  name: "RoomList",
  components: {
    RoomListItem,
    PasswordInput,
    AlertDialog
  },
  setup() {
    const router = useRouter();
    const store = useStore();
    const state = reactive({
      isTeamBattle: false,
       
      teamrooms: [],
      privaterooms: [],
      roomlist: computed(() => {
        if (state.isTeamBattle) {
          return state.teamrooms;
        } else {
          return state.privaterooms;
        }
      }),
      passwordDialog: false,
      alert: false,
      pageNum: 0
    });

    const getInRoom = async function (params) {
      const roominfo = JSON.parse(JSON.stringify(params));
      const isExistRoom=await getRoom(roominfo.sessionId);
      if(!isExistRoom) {
        state.alert = false
        await store.commit('accountStore/setAlertColor', 'error')
        await store.commit('accountStore/setAlertMessage', '존재하지 않는 방입니다.')
        await store.commit('accountStore/setAlertIcon', 'alert')
        state.alert = true
        return;
      }
      else {
        if (roominfo.isSecret) {
          state.passwordDialog = true
        } else {
          console.log(state.password)
          console.log(roominfo.isTeamBattle)
          store.commit("gameStore/setTitle", roominfo.title);
          store.commit("gameStore/setTeam", roominfo.isTeamBattle);
          store.commit("gameStore/setSecret", roominfo.isSecret);
          store.commit("gameStore/setPassword", roominfo.password);
          router.push({
            name: "gameroom",
            params: { sessionId: roominfo.sessionId },
          });
        }
      }
    };
    // 없는 방 조회시 오류 반환
    const getRoom = (sessionId) => {
      const response= room(sessionId);
      return response;
    }
    // 페이지네이션
    const pageList = computed(() => {
        let listLeng = state.roomlist.length;
        let listSize = 5;
        let page = Math.floor(listLeng / listSize);
        if (listLeng % listSize > 0) {
            page += 1
        }
        return page
        });
    const paginatedData = computed(() => {
        const start = state.pageNum * 5;
        const end = start + 5;
        return state.roomlist.slice(start, end);
        })
    const nextPage = function() {
        state.pageNum += 1
    }
    const prevPage = function() {
        state.pageNum -= 1
    }
    const nextButtonDisabled = computed(() => state.pageNum >= Math.floor(state.roomlist.length / 5));
    
    const prevButtonDisabled = computed(() => state.pageNum < 1);
    // 방 리스트 조회
    onMounted(async () => {
      // 팀 분류하기 - 이은혁
      const response = await roomList();
      console.log(response);
      for (let i = 0; i < response.content.length; i++) {
        if (
          !response.content[i].isPlaying &&
          response.content[i].connections.numberOfElements < 4
        ) {
          if (response.content[i].isTeamBattle) {
            state.teamrooms.push(response.content[i]);
          } else {
            state.privaterooms.push(response.content[i]);
          }
        }
      }
    });

    return {
      state,
      getInRoom,
      pageList,
      paginatedData,
      nextPage,
      prevPage,
      nextButtonDisabled,
      prevButtonDisabled,
    };
  },
};
</script>
<style scoped>
.roomlist {
  background: white;
  border-radius: 60px;
  overflow: hidden;
  box-shadow: 0px 0px 50px #0000005c;
}
#earth {
  width: 125px;
  height: 125px;
  position: absolute;
  margin-right: 50%;
  right: -62.5px;
  top: -14px;
  z-index: 1;
  box-shadow: 0px 5px 30px 8px #187a9ba8;
  border-radius: 100px;
}
.wrap-btn {
  position: relative;
}
.wrap-btn > button {
  width: 50%;
  height: 60px;
  font-size: 23px;
  background: #d3d3d3;
  color: white;
  font-weight: 500;
  box-shadow: inset 0px -4px 10px #0000003d;
  text-shadow: 0px 0px 4px rgba(255, 255, 255, 0.567);
}
.wrap-btn > button.active {
  background: none;
  color: black;
  box-shadow: none;
}
.wrap-list {
  height: 390px;
  padding: 25px 55px;
}
.list-item {
  width: 100%;
  height: 50px;
  margin: 10px 0;
  border-radius: 10px;
  background: #f5f5f5;
  box-shadow: 2px 4px 5px 0px #00000024;
  transition: 0.1s;
  cursor: pointer;
}
.list-item.blank {
  background: none;
  cursor: auto;
  box-shadow: none;
  border: 1px solid #e6e6e6;
}
.list-item:hover {
  background: #24CB83;
  color: white;
}
.list-item.blank:hover {
  background: none;
}
.list-item.blank:active {
  background: none;
}
.list-item:active {
  background: #1fae70;
  color: white;
}
.btn-paging {
  padding: 11px 0;
}
.btn-paging>button {
  font-size: 15px;
  margin: 0 10px;
}
</style>